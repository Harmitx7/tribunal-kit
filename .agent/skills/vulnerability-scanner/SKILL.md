---
name: vulnerability-scanner
description: Advanced vulnerability analysis principles. OWASP 2025, Supply Chain Security, attack surface mapping, risk prioritization.
allowed-tools: Read, Write, Edit, Glob, Grep
---

# Vulnerability Analysis Principles

> Security is not a feature. It is a property of the entire system.
> One unguarded input means one unguarded way in.

---

## Threat Modeling First

Before scanning for vulnerabilities, map what you're protecting:

```
1. ASSETS:    What data or capabilities would damage the business if compromised?
2. THREAT ACTORS: Who would want to compromise this? (external attacker, malicious insider, bot)
3. ENTRY POINTS: Where does untrusted data enter the system?
4. TRUST BOUNDARIES: Where does data cross from untrusted to trusted?
```

Prioritize findings based on the assets they expose — not just their CVSS score.

---

## OWASP API Top 10 (2023)

Review every API surface against these:

| # | Vulnerability | Key Pattern to Check |
|---|---|---|
| 1 | Broken Object Level Authorization | Does route A let user X access user Y's objects? |
| 2 | Broken Authentication | Token validation, session fixation, brute-force protection |
| 3 | Broken Object Property Level Authorization | Mass assignment — can user set fields they shouldn't? |
| 4 | Unrestricted Resource Consumption | Rate limiting on all endpoints |
| 5 | Broken Function Level Authorization | Are admin-only routes actually admin-only? |
| 6 | Unrestricted Access to Sensitive Business Flows | Can bots exploit checkout, voting, invites? |
| 7 | SSRF | Does user input control URLs that the server fetches? |
| 8 | Security Misconfiguration | Debug mode in prod, open CORS, default credentials |
| 9 | Improper Inventory Management | Undocumented endpoints, unversioned old APIs |
| 10 | Unsafe API Consumption | Does the server blindly trust third-party API data it consumes? |

---

## Critical Code Patterns to Flag

### SQL Injection

```ts
// ❌ Critical: string concatenation into query
const query = `SELECT * FROM users WHERE email = '${email}'`;

// ✅ Parameterized
const user = await db.query('SELECT * FROM users WHERE email = $1', [email]);
```

### XSS (Cross-Site Scripting)

```ts
// ❌ Direct DOM injection of untrusted content
element.innerHTML = userContent;

// ✅ Text only — or sanitize with DOMPurify for rich text
element.textContent = userContent;
element.innerHTML = DOMPurify.sanitize(userContent);
```

### Broken Authorization

```ts
// ❌ Missing ownership check — user can access any resource
app.get('/api/documents/:id', async (req, res) => {
  const doc = await Document.findById(req.params.id);  // no user check
  res.json(doc);
});

// ✅ Ownership enforced
app.get('/api/documents/:id', authenticate, async (req, res) => {
  const doc = await Document.findOne({
    _id: req.params.id,
    ownerId: req.user.id  // must belong to requesting user
  });
  if (!doc) return res.status(404).json({ error: 'Not found' });
  res.json(doc);
});
```

### Hardcoded Secrets

```ts
// ❌ Secret in source code
const apiKey = 'sk-prod-abc123xyz';

// ✅ From environment
const apiKey = process.env.OPENAI_API_KEY;
if (!apiKey) throw new Error('OPENAI_API_KEY is required');
```

---

## Supply Chain Security

Dependencies are an attack surface. Treat them as code you inherit.

**Regular practice:**
```bash
# Node.js
npm audit
npx better-npm-audit --level high

# Python
pip-audit

# Check for typosquatting before installing new packages
# Does the package name look like a popular package with a typo?
# verify: npmjs.com/package/<name> → is the author who you expect?
```

**Rules:**
- Dependencies with known High or Critical CVEs must be updated before deploy
- Lock files (`package-lock.json`, `poetry.lock`) must be committed
- Unpinned dependencies in production = unknown risk

---

## Risk Prioritization

Not all vulnerabilities are equal. Prioritize by:

**1. Exploitability** — can it be exploited by an unauthenticated attacker remotely?
**2. Impact** — what happens if it's exploited? (data exposure > availability)
**3. Likelihood** — is this endpoint public? High traffic? Targeted by bots?

```
CRITICAL: Remote unauthenticated exploitation, high-value data exposure
          → Fix before this code ships to production

HIGH:     Authentication bypass, SQLi, IDOR
          → Fix within 24 hours of discovery in production

MEDIUM:   Authenticated user can access other users' data
          → Fix within the current sprint

LOW:      Missing security header, verbose error message
          → Fix within 30 days
```

---

## Scripts

| Script | Purpose | Run With |
|---|---|---|
| `scripts/security_scan.py` | Scans codebase for common vulnerability patterns | `python scripts/security_scan.py <project_path>` |
| `checklists.md` | Manual security review checklists by layer | Load and follow |
